{
    "type": "page",
    "body": [
        {
            "type": "crud",
            "id": "recordCRUD",
            "name": "recordCRUD",
            "autoFillHeight": true,
            "autoGenerateFilter": true,
            "api": "get:/admin/inspection/record/list",
            "headerToolbar": [
                {
                    "type": "columns-toggler",
                    "align": "right",
                    "draggable": true,
                    "icon": "fas fa-cog",
                    "overlay": true,
                    "footerBtnSize": "sm"
                },
                {
                    "type": "tpl",
                    "tpl": "共${count}条",
                    "align": "right",
                    "visibleOn": "${count}"
                },
                {
                    "type": "columns-toggler",
                    "align": "left"
                },
                "reload"
            ],
            "loadDataOnce": false,
            "syncLocation": false,
            "initFetch": true,
            "perPage": 10,
            "columns": [
                {
                    "type": "operation",
                    "label": "操作",
                    "width": 200,
                    "buttons": [
                        {
                            "type": "button",
                            "actionType": "ajax",
                            "label": "生成AI总结",
                            "icon": "fas fa-robot",
                            "level": "primary",
                            "size": "sm",
                            "api": "post:/admin/inspection/schedule/record/id/$id/summary",
                            "confirmText": "确定要生成AI总结吗？",
                            "reload": "recordCRUD",
                            "messages": {
                                "success": "AI总结生成成功",
                                "failed": "AI总结生成失败"
                            }
                        },
                        {
                            "type": "button",
                            "actionType": "drawer",
                            "label": "查看结果详情",
                            "drawer": {
                                "closeOnEsc": true,
                                "closeOnOutside": true,
                                "size": "xl",
                                "title": "查看巡检结果明细 (ESC 关闭)",
                                "body": [
                                    {
                                        "type": "inspectionEventList",
                                        "record_id": "${id}"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "button",
                            "actionType": "drawer",
                            "label": "查看脚本运行日志",
                            "drawer": {
                                "closeOnEsc": true,
                                "closeOnOutside": true,
                                "size": "xl",
                                "title": "查看脚本执行输出内容 (ESC 关闭)",
                                "body": [
                                    {
                                        "type": "alert",
                                        "level": "info",
                                        "body": "<strong>注意：</strong>该页面展示内容为对应规则脚本（lua）在运行时的标准输出、错误输出。"
                                    },
                                    {
                                        "type": "crud",
                                        "id": "scriptOutputCRUD",
                                        "name": "scriptOutputCRUD",
                                        "autoFillHeight": true,
                                        "api": "get:/admin/inspection/schedule/record/id/$id/output/list",
                                        "headerToolbar": [
                                            {
                                                "type": "columns-toggler",
                                                "align": "right",
                                                "draggable": true,
                                                "icon": "fas fa-cog",
                                                "overlay": true,
                                                "footerBtnSize": "sm"
                                            },
                                            {
                                                "type": "tpl",
                                                "tpl": "共${count}条",
                                                "align": "right",
                                                "visibleOn": "${count}"
                                            },
                                            {
                                                "type": "columns-toggler",
                                                "align": "left"
                                            },
                                            "reload"
                                        ],
                                        "loadDataOnce": true,
                                        "syncLocation": false,
                                        "initFetch": true,
                                        "perPage": 10,
                                        "columns": [
                                            {
                                                "name": "script_name",
                                                "label": "规则名称"
                                            },
                                            {
                                                "name": "cluster",
                                                "label": "集群"
                                            },
                                            {
                                                "name": "std_output",
                                                "label": "标准输出"
                                            },
                                            {
                                                "name": "error_msg",
                                                "label": "错误输出",
                                                "type": "control",
                                                "body": [
                                                    {
                                                        "type": "tpl",
                                                        "tpl": "${error_msg?error_msg:''}"
                                                    },
                                                    {
                                                        "type": "button",
                                                        "label": "查",
                                                        "level": "link",
                                                        "actionType": "drawer",
                                                        "drawer": {
                                                            "closeOnEsc": true,
                                                            "closeOnOutside": true,
                                                            "size": "lg",
                                                            "title": "AI释义",
                                                            "body": [
                                                                {
                                                                    "type": "websocketMarkdownViewer",
                                                                    "url": "/ai/chat/any_selection",
                                                                    "params": {
                                                                        "question": "请详细解读下面的集群巡检结果所代表的含义：${error_msg}。"
                                                                    }
                                                                }
                                                            ]
                                                        },
                                                        "visibleOn": "${error_msg}"
                                                    }
                                                ]
                                            },
                                            {
                                                "name": "start_time",
                                                "label": "开始时间",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "end_time",
                                                "label": "结束时间",
                                                "type": "datetime"
                                            }
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "type": "button",
                            "actionType": "ajax",
                            "label": "重新触发webhook",
                            "api": "post:/admin/inspection/schedule/record/id/$id/push"
                        }
                    ]
                },
                {
                    "name": "id",
                    "label": "ID",
                    "type": "text"
                },
                {
                    "name": "schedule_id",
                    "label": "巡检计划名称",
                    "type": "tpl",
                    "width": "100px",
                    "searchable": true,
                    "tpl": "${schedule_name}<span class='text-gray-500 text-xs'>[${schedule_id}]</span>"
                },
                {
                    "name": "cluster",
                    "label": "目标集群"
                },
                {
                    "name": "trigger_type",
                    "label": "触发类型",
                    "type": "mapping",
                    "map": {
                        "cron": "<span class='label label-success'>定时任务</span>",
                        "manual": "<span class='label label-danger'>手动触发</span>"
                    }
                },
                {
                    "name": "status",
                    "label": "状态",
                    "type": "mapping",
                    "map": {
                        "success": "<span class='label label-success'>成功</span>",
                        "failed": "<span class='label label-danger'>失败</span>",
                        "running": "<span class='label label-warning'>运行中</span>"
                    }
                },
                {
                    "name": "error_count",
                    "label": "错误数量"
                },
                {
                    "name": "ai_summary_combined",
                    "label": "AI总结",
                    "type": "container",
                    "width": "250px",
                    "body": [
                        {
                            "type": "tpl",
                            "tpl": "${ai_summary}",
                            "style": {
                                "display": "inline-block",
                                "marginRight": "8px"
                            }
                        },
                        {
                            "type": "tpl",
                            "tpl": "<% if (data.ai_summary_err) { %><i class='fa fa-exclamation-triangle text-danger'></i><% } %>",
                            "onEvent": {
                                "click": {
                                    "actions": [
                                        {
                                            "actionType": "dialog",
                                            "dialog": {
                                                "title": "AI总结错误详情 (ESC 关闭)",
                                                "name": "dialog_ai_summary_err",
                                                "body": [
                                                    {
                                                        "type": "alert",
                                                        "level": "danger",
                                                        "body": "${ai_summary_err}"
                                                    }
                                                ],
                                                "size": "lg",
                                                "closeOnEsc": true,
                                                "closeOnOutside": true
                                            }
                                        }
                                    ]
                                }
                            },
                            "style": {
                                "cursor": "pointer",
                                "display": "inline-block"
                            }
                        }
                    ]
                },
                {
                    "name": "start_time",
                    "label": "开始时间",
                    "type": "datetime"
                },
                {
                    "name": "end_time",
                    "label": "结束时间",
                    "type": "datetime"
                }
            ]
        }
    ]
}